<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/png" href="../../assets/images/StrikeMasterLogo2.png">
  <link rel="stylesheet" type="text/css" href="../../assets/css/stored-colors.css">
  <script src="../../assets/js/accent-loader.js"></script>
  <script src="../../assets/js/config/api.js"></script>
  <script src="../../assets/js/config/teams.js"></script>
  <script src="../../assets/js/auth-helper.js"></script>
  <title>Settings - Strike Master</title>

  <style>
    :root {
      --accent-color: #ffa500;
      --main-color: #5f371c;
      --bg-color: #f9f9f9;
      --content-bg: #ececec;
      --card-bg: #ededed;
      --text-color: #000000;
    }

    [data-theme="dark"] {
      --bg-color: #343434;
      --content-bg: #3e3e3e;
      --card-bg: #434343;
      --text-color: #ffffff;
    }

    body {
      margin: 0;
      font-family: Arial, sans-serif;
      display: flex;
      height: 100vh;
      background: var(--bg-color);
    }

    /* Sidebar */
    .sidebar {
      width: 200px;
      background: var(--main-color);
      color: var(--sidebar-text-color, white);
      display: flex;
      flex-direction: column;
      padding: 20px 0;
    }

    .sidebar a {
      background: none;
      border: none;
      color: var(--sidebar-text-color, white);
      padding: 15px 20px;
      text-align: left;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.2s;
      text-decoration: none;
      display: block;
    }

    .sidebar a:hover {
      background: color-mix(in srgb, var(--accent-color) 50%, black);
    }

    .sidebar a.active {
      background: var(--accent-color);
    }

    /* Main content */
    .content {
      flex: 1;
      padding: 30px;
      background: var(--bg-color);
      overflow-y: auto;
      color: var(--text-color);
      position: relative;
    }

    h2 {
      margin-top: 0;
      color: var(--accent-color);
    }

    h3 {
      margin-top: 30px;
      margin-bottom: 15px;
      color: var(--text-color);
      border-bottom: 2px solid var(--accent-color);
      padding-bottom: 8px;
    }

    .setting-group {
      background: var(--card-bg);
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .setting-row {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 15px;
    }

    .setting-row:last-child {
      margin-bottom: 0;
    }

    .setting-row label {
      min-width: 120px;
      font-weight: 600;
    }

    .setting-row input[type="color"] {
      width: 60px;
      height: 40px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    .setting-row button {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      background: var(--accent-color);
      color: white;
    }

    .setting-row button:hover {
      filter: brightness(0.9);
    }

    .reset-btn {
      background: #666 !important;
    }

    /* Logo Grid */
    .logo-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .logo-option {
      background: var(--content-bg);
      border: 3px solid transparent;
      border-radius: 10px;
      padding: 15px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .logo-option:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .logo-option.selected {
      border-color: var(--accent-color);
      background: rgba(255, 165, 0, 0.1);
    }

    .logo-option img {
      width: 80px;
      height: 80px;
      object-fit: contain;
      margin-bottom: 8px;
    }

    .logo-option span {
      display: block;
      font-size: 12px;
      color: var(--text-color);
      word-break: break-word;
    }

    .current-logo-preview {
      display: flex;
      align-items: center;
      gap: 20px;
      padding: 15px;
      background: var(--content-bg);
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .current-logo-preview img {
      width: 60px;
      height: 60px;
      object-fit: contain;
    }

    .current-logo-preview .info h4 {
      margin: 0 0 5px 0;
      color: var(--accent-color);
    }

    .current-logo-preview .info span {
      font-size: 13px;
      color: #888;
    }

    #logoutBtn {
      margin-top: auto;
      color: rgb(235, 76, 76);
      background: none;
      border: none;
      padding: 15px 20px;
      text-align: left;
      font-size: 16px;
      cursor: pointer;
    }

    #logoutBtn:hover {
      background: var(--accent-color);
    }

    .close-icon {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 20px;
      color: var(--text-color);
      text-decoration: none;
      font-weight: bold;
      padding: 20px;
    }

    .close-icon:hover {
      color: var(--accent-color);
    }

    .message {
      padding: 12px;
      margin-bottom: 20px;
      border-radius: 5px;
      text-align: center;
      font-weight: 600;
      display: none;
    }

    .message.success {
      background: #d4edda;
      color: #155724;
      display: block;
    }

    .message.error {
      background: #f8d7da;
      color: #721c24;
      display: block;
    }

    /* Preset Colors */
    .preset-colors {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
    }

    .preset-color {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      cursor: pointer;
      border: 3px solid transparent;
      transition: transform 0.2s, border-color 0.2s;
    }

    .preset-color:hover {
      transform: scale(1.1);
    }

    .preset-color.selected {
      border-color: var(--text-color);
    }
  </style>
</head>

<body>

  <div class="sidebar">
    <a href="appearanceSettings.html" class="active">Appearance</a>
    <a href="accountInfo.html">Account Info</a>
    <button id="logoutBtn">Logout</button>
  </div>

  <div class="content">
    <a href="../dashboard/teamSelector.html" class="close-icon">X</a>

    <h2>Appearance Settings</h2>
    <div id="message" class="message"></div>

    <!-- Theme Section -->
    <h3>Theme</h3>
    <div class="setting-group">
      <div class="setting-row">
        <label>Mode:</label>
        <button id="themeToggle">Toggle Light / Dark</button>
      </div>
    </div>

    <!-- Accent Color Section -->
    <h3>Accent Color</h3>
    <div class="setting-group">
      <div class="setting-row">
        <label>Custom:</label>
        <input type="color" id="accentColorPicker" value="#ffa500">
        <button id="resetAccent" class="reset-btn">Reset</button>
      </div>
      <p style="margin: 10px 0 5px; font-size: 13px; color: #888;">Quick Presets:</p>
      <div class="preset-colors" id="accentPresets">
        <div class="preset-color" data-color="#ffa500" style="background: #ffa500;" title="Orange (Default)"></div>
        <div class="preset-color" data-color="#e74c3c" style="background: #e74c3c;" title="Red"></div>
        <div class="preset-color" data-color="#3498db" style="background: #3498db;" title="Blue"></div>
        <div class="preset-color" data-color="#2ecc71" style="background: #2ecc71;" title="Green"></div>
        <div class="preset-color" data-color="#9b59b6" style="background: #9b59b6;" title="Purple"></div>
        <div class="preset-color" data-color="#1abc9c" style="background: #1abc9c;" title="Teal"></div>
        <div class="preset-color" data-color="#f39c12" style="background: #f39c12;" title="Gold"></div>
        <div class="preset-color" data-color="#e91e63" style="background: #e91e63;" title="Pink"></div>
      </div>
    </div>

    <!-- Main/Sidebar Color Section -->
    <h3>Sidebar Color</h3>
    <div class="setting-group">
      <div class="setting-row">
        <label>Custom:</label>
        <input type="color" id="mainColorPicker" value="#5f371c">
        <button id="resetMain" class="reset-btn">Reset</button>
      </div>
      <p style="margin: 10px 0 5px; font-size: 13px; color: #888;">Quick Presets:</p>
      <div class="preset-colors" id="mainPresets">
        <div class="preset-color" data-color="#5f371c" style="background: #5f371c;" title="Brown (Default)"></div>
        <div class="preset-color" data-color="#2c3e50" style="background: #2c3e50;" title="Navy"></div>
        <div class="preset-color" data-color="#1a1a2e" style="background: #1a1a2e;" title="Dark Blue"></div>
        <div class="preset-color" data-color="#1e272e" style="background: #1e272e;" title="Charcoal"></div>
        <div class="preset-color" data-color="#341f97" style="background: #341f97;" title="Indigo"></div>
        <div class="preset-color" data-color="#222f3e" style="background: #222f3e;" title="Dark Slate"></div>
        <div class="preset-color" data-color="#4a0e0e" style="background: #4a0e0e;" title="Maroon"></div>
        <div class="preset-color" data-color="#0c3c26" style="background: #0c3c26;" title="Forest"></div>
      </div>
    </div>

    <!-- Team Logo Section -->
    <h3>Team Logo</h3>
    <div class="setting-group">
      <p style="margin: 0 0 10px; font-size: 14px;">Current Logo:</p>
      <div class="current-logo-preview">
        <img id="currentLogoImg" src="../../assets/images/Team Logos/phLogo.png" alt="Current Logo">
        <div class="info">
          <h4 id="currentLogoName">phLogo</h4>
          <span>Displayed in navbar across all pages</span>
        </div>
      </div>
      <p style="margin: 15px 0 10px; font-size: 14px;">Available Logos:</p>
      <div class="logo-grid" id="logoGrid">
        <!-- Logos will be loaded here -->
      </div>
    </div>
  </div>

  <script>
    // Available team logos - use centralized teams.js config
    const availableLogos = getAvailableLogos();

    // Current selected logo
    let currentLogo = localStorage.getItem('teamLogo') || 'phLogo.png';

    // Initialize logo grid
    function initLogoGrid() {
      const grid = document.getElementById('logoGrid');
      grid.innerHTML = availableLogos.map(logo => `
        <div class="logo-option ${logo.file === currentLogo ? 'selected' : ''}" data-logo="${logo.file}" data-accent="${logo.accentColor}" data-main="${logo.mainColor}">
          <img src="../../assets/images/Team Logos/${logo.file}" alt="${logo.name}">
          <span>${logo.name}</span>
        </div>
      `).join('');

      // Add click handlers
      grid.querySelectorAll('.logo-option').forEach(option => {
        option.addEventListener('click', () => {
          const logoFile = option.dataset.logo;
          const accentColor = option.dataset.accent;
          const mainColor = option.dataset.main;
          selectLogo(logoFile, accentColor, mainColor);
        });
      });

      // Update current preview
      updateCurrentLogoPreview();
    }

    function selectLogo(logoFile, accentColor, mainColor) {
      currentLogo = logoFile;
      localStorage.setItem('teamLogo', logoFile);

      // Update selection UI
      document.querySelectorAll('.logo-option').forEach(opt => {
        opt.classList.toggle('selected', opt.dataset.logo === logoFile);
      });

      // Apply school colors if provided
      if (accentColor) {
        picker.value = accentColor;
        localStorage.setItem("accentColor", accentColor);
        document.documentElement.style.setProperty("--accent-color", accentColor);
        updatePresetSelection('accentPresets', accentColor);
      }
      if (mainColor) {
        mainPicker.value = mainColor;
        localStorage.setItem("mainColor", mainColor);
        document.documentElement.style.setProperty("--main-color", mainColor);
        updatePresetSelection('mainPresets', mainColor);
        updateSidebarTextColor(mainColor);
      }

      updateCurrentLogoPreview();
      showMessage('Logo and colors updated! Changes will appear across all pages.', 'success');
    }

    function updateCurrentLogoPreview() {
      const logo = availableLogos.find(l => l.file === currentLogo);
      document.getElementById('currentLogoImg').src = `../../assets/images/Team Logos/${currentLogo}`;
      document.getElementById('currentLogoName').textContent = logo ? logo.name : currentLogo;
    }

    /* ---------------------------------------------------
       ACCENT COLOR SYSTEM
    --------------------------------------------------- */
    (function applySavedAccent() {
      const saved = localStorage.getItem("accentColor");
      if (saved) {
        document.documentElement.style.setProperty("--accent-color", saved);
      }
    })();

    const picker = document.getElementById("accentColorPicker");
    if (picker) {
      const saved = localStorage.getItem("accentColor");
      if (saved) picker.value = saved;

      picker.addEventListener("input", (e) => {
        const color = e.target.value;
        localStorage.setItem("accentColor", color);
        document.documentElement.style.setProperty("--accent-color", color);
        updatePresetSelection('accentPresets', color);
      });
    }

    // Preset color clicks for accent
    document.querySelectorAll('#accentPresets .preset-color').forEach(preset => {
      preset.addEventListener('click', () => {
        const color = preset.dataset.color;
        picker.value = color;
        localStorage.setItem("accentColor", color);
        document.documentElement.style.setProperty("--accent-color", color);
        updatePresetSelection('accentPresets', color);
      });
    });

    /* ---------------------------------------------------
       MAIN COLOR SYSTEM
    --------------------------------------------------- */
    (function applySavedMain() {
      const saved = localStorage.getItem("mainColor");
      if (saved) {
        document.documentElement.style.setProperty("--main-color", saved);
        updateSidebarTextColor(saved);
      }
    })();

    // Function to check if color is light and update sidebar text color
    function updateSidebarTextColor(hex) {
      const c = hex.replace('#', '');
      const r = parseInt(c.substr(0, 2), 16);
      const g = parseInt(c.substr(2, 2), 16);
      const b = parseInt(c.substr(4, 2), 16);
      const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
      
      if (luminance > 0.5) {
        document.documentElement.style.setProperty("--sidebar-text-color", "#000000");
        document.documentElement.classList.add('light-sidebar');
      } else {
        document.documentElement.style.setProperty("--sidebar-text-color", "#ffffff");
        document.documentElement.classList.remove('light-sidebar');
      }
    }

    const mainPicker = document.getElementById("mainColorPicker");
    if (mainPicker) {
      const saved = localStorage.getItem("mainColor");
      if (saved) mainPicker.value = saved;

      mainPicker.addEventListener("input", (e) => {
        const color = e.target.value;
        localStorage.setItem("mainColor", color);
        document.documentElement.style.setProperty("--main-color", color);
        updateSidebarTextColor(color);
        updatePresetSelection('mainPresets', color);
      });
    }

    // Preset color clicks for main
    document.querySelectorAll('#mainPresets .preset-color').forEach(preset => {
      preset.addEventListener('click', () => {
        const color = preset.dataset.color;
        mainPicker.value = color;
        localStorage.setItem("mainColor", color);
        document.documentElement.style.setProperty("--main-color", color);
        updateSidebarTextColor(color);
        updatePresetSelection('mainPresets', color);
      });
    });

    function updatePresetSelection(containerId, selectedColor) {
      document.querySelectorAll(`#${containerId} .preset-color`).forEach(preset => {
        preset.classList.toggle('selected', preset.dataset.color === selectedColor);
      });
    }

    // Initialize preset selections
    updatePresetSelection('accentPresets', localStorage.getItem("accentColor") || "#ffa500");
    updatePresetSelection('mainPresets', localStorage.getItem("mainColor") || "#5f371c");

    /* ---------------------------------------------------
       LIGHT / DARK MODE
    --------------------------------------------------- */
    (function () {
      const savedTheme = localStorage.getItem("theme") || "light";
      document.documentElement.setAttribute("data-theme", savedTheme);
    })();

    document.getElementById("themeToggle").addEventListener("click", () => {
      const html = document.documentElement;
      const current = html.getAttribute("data-theme");
      const next = current === "dark" ? "light" : "dark";

      html.setAttribute("data-theme", next);
      localStorage.setItem("theme", next);
    });

    /* ---------------------------------------------------
       RESET BUTTONS
    --------------------------------------------------- */
    document.getElementById("resetAccent").addEventListener("click", () => {
      const defaultColor = "#ffa500";
      picker.value = defaultColor;
      document.documentElement.style.setProperty("--accent-color", defaultColor);
      localStorage.setItem("accentColor", defaultColor);
      updatePresetSelection('accentPresets', defaultColor);
    });

    document.getElementById("resetMain").addEventListener("click", () => {
      const defaultColor = "#5f371c";
      mainPicker.value = defaultColor;
      document.documentElement.style.setProperty("--main-color", defaultColor);
      localStorage.setItem("mainColor", defaultColor);
      updatePresetSelection('mainPresets', defaultColor);
    });

    /* ---------------------------------------------------
       MESSAGE HELPER
    --------------------------------------------------- */
    function showMessage(text, type) {
      const msg = document.getElementById('message');
      msg.textContent = text;
      msg.className = `message ${type}`;
      setTimeout(() => { msg.className = 'message'; }, 3000);
    }

    /* ---------------------------------------------------
       LOGOUT
    --------------------------------------------------- */
    document.getElementById('logoutBtn').addEventListener('click', () => {
      if (confirm('Are you sure you want to logout?')) {
        auth.logout('../../index.html');
      }
    });

    // Require authentication
    if (!auth.requireCoach('../auth/teacherLogin.html')) {
      throw new Error('Not authenticated');
    }

    // Initialize
    initLogoGrid();
  </script>

</body>
</html>
