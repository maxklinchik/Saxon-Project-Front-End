<!DOCTYPE html>
<html lang="en" data-ui="cartoon">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Players - Strike Master</title>
  <link rel="icon" type="image/png" href="../../assets/images/BowlingPinCartoon.png">
  <link rel="stylesheet" type="text/css" href="../../assets/css/stored-colors.css">
  <link rel="stylesheet" type="text/css" href="../../assets/css/cartoon-ui.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="../../assets/js/accent-loader.js"></script>
  <script src="../../assets/js/season-context.js"></script>
  <script src="../../assets/js/config/api.js"></script>
  <script src="../../assets/js/config/teams.js"></script>
  <script src="../../assets/js/auth-helper.js"></script>
  <style>
    :root {
      --accent-color: #ff6b6b;
      --main-color: #6ecbff;
      --bg-color: #fff4c2;
      --content-bg: #fff9e2;
      --card-bg: #ffffff;
      --text-color: #1f1f1f;
      --text-muted: #4b4b4b;
      --border-color: rgba(0, 0, 0, 0.12);
    }

    [data-theme="dark"] {
      --bg-color: #1f1f1f;
      --content-bg: #2a2a2a;
      --card-bg: #2f2f2f;
      --text-color: #f8f8f8;
      --text-muted: #c8c8c8;
      --border-color: rgba(255, 255, 255, 0.18);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: 'Nunito', 'Segoe UI', sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      min-height: 100vh;
    }

    /* Navbar */
    .navbar {
      background: var(--main-color);
      padding: 12px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .navbar .logo img { height: 46px; width: 46px; object-fit: contain; }

    .nav-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .season-select {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 2px solid rgba(0, 0, 0, 0.12);
      background: rgba(255, 255, 255, 0.75);
    }

    .season-select label {
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.4px;
      text-transform: uppercase;
      color: var(--text-color);
    }

    .season-select select {
      border: none;
      background: transparent;
      font-weight: 700;
      font-size: 13px;
      color: var(--text-color);
      font-family: inherit;
    }

    .season-select select:focus {
      outline: none;
    }

    .nav-links { display: flex; gap: 8px; align-items: center; }

    .nav-links a {
      color: rgba(255,255,255,0.85);
      text-decoration: none;
      padding: 10px 16px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.2s;
    }

    .nav-links a:hover { background: rgba(255,255,255,0.1); }
    .nav-links a.active { background: var(--accent-color); color: var(--accent-text-color, white); }

    /* Container */
    .container { max-width: 1000px; margin: 0 auto; padding: 32px 24px; }

    /* Page Header */
    .page-header { margin-bottom: 32px; }
    .page-header h1 { font-size: 32px; font-weight: 700; margin: 0 0 8px; }
    .page-header p { margin: 0; color: var(--text-muted); font-size: 15px; }

    /* Tabs */
    .tabs { display: flex; gap: 8px; margin-bottom: 24px; }

    .tab-btn {
      padding: 10px 20px;
      border: 2px solid var(--dashboard-button-border, var(--button-border-color, var(--border-color)));
      background: var(--dashboard-button-bg, var(--card-bg));
      color: var(--dashboard-button-text, var(--text-color));
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      font-family: inherit;
      transition: all 0.2s;
      box-shadow: 0 4px 0 var(--button-shadow-color, rgba(0, 0, 0, 0.15));
    }

    .tab-btn:hover { border-color: var(--accent-color); }
    .tab-btn.active { background: var(--accent-color); color: var(--accent-text-color, white); border-color: var(--accent-color); }

    .view-toggle {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
    }

    .view-btn {
      padding: 10px 20px;
      border: 2px solid var(--dashboard-button-border, var(--button-border-color, var(--border-color)));
      background: var(--dashboard-button-bg, var(--card-bg));
      color: var(--dashboard-button-text, var(--text-color));
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
      font-family: inherit;
      transition: all 0.2s;
      box-shadow: 0 4px 0 var(--button-shadow-color, rgba(0, 0, 0, 0.15));
    }

    .view-btn:hover { border-color: var(--accent-color); }
    .view-btn.active { background: var(--accent-color); color: var(--accent-text-color, white); border-color: var(--accent-color); }

    /* Card */
    .card {
      background: var(--card-bg);
      border-radius: 12px;
      border: 1px solid var(--border-color);
      margin-bottom: 24px;
      overflow: hidden;
    }

    .card-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 20px;
      border-bottom: 1px solid var(--border-color);
    }

    .card-header .icon {
      width: 40px;
      height: 40px;
      background: color-mix(in srgb, var(--accent-color) 15%, transparent);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .card-header .icon svg { width: 22px; height: 22px; stroke: var(--accent-color); }
    .card-header h3 { margin: 0; font-size: 16px; font-weight: 600; }
    .card-header p { margin: 2px 0 0; font-size: 13px; color: var(--text-muted); }

    .card-body { padding: 20px; }

    /* Add Player Form */
    .add-form { display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 16px; align-items: end; }

    .form-group label { display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px; }

    .form-group input, .form-group select {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      background: var(--content-bg);
      color: var(--text-color);
    }

    .form-group input:focus, .form-group select:focus {
      outline: none;
      border-color: var(--accent-color);
    }

    .add-btn {
      padding: 12px 24px;
      background: var(--accent-color);
      color: var(--accent-text-color, white);
      border: 2px solid var(--button-border-color, rgba(0, 0, 0, 0.18));
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      font-family: inherit;
      cursor: pointer;
      height: fit-content;
      transition: all 0.2s;
      box-shadow: 0 4px 0 var(--button-shadow-color, rgba(0, 0, 0, 0.15));
    }

    .add-btn:hover { filter: brightness(0.95); }

    /* Players List */
    .player-card {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border-color);
      cursor: pointer;
      transition: all 0.2s;
    }

    .player-card:last-child { border-bottom: none; }
    .player-card:hover { background: var(--content-bg); }

    .player-card.selected {
      background: color-mix(in srgb, var(--accent-color) 10%, transparent);
      border-left: 3px solid var(--accent-color);
    }

    .player-info h4 { margin: 0 0 4px; font-size: 15px; font-weight: 600; }
    .player-info span { font-size: 13px; color: var(--text-muted); }

    .player-actions { display: flex; gap: 8px; }

    .remove-btn {
      padding: 8px 16px;
      background: transparent;
      color: #ef4444;
      border: 1px solid #ef4444;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .remove-btn:hover { background: #fef2f2; }

    .no-players { text-align: center; padding: 48px 24px; color: var(--text-muted); }

    .spreadsheet-container {
      overflow-x: auto;
      border-radius: 12px;
      border: 2px solid var(--button-border-color, var(--border-color));
    }

    .spreadsheet-table {
      width: 100%;
      border-collapse: collapse;
      min-width: 620px;
      background: var(--card-bg);
      font-size: 14px;
    }

    .spreadsheet-table th {
      background: var(--content-bg);
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 11px;
      font-weight: 700;
      padding: 12px 10px;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }

    .spreadsheet-table td {
      padding: 12px 10px;
      border-bottom: 1px solid var(--border-color);
    }

    .spreadsheet-table tbody tr:hover {
      background: var(--content-bg);
    }

    /* Stats Panel */
    .stats-panel {
      display: none;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      margin-top: 24px;
      overflow: hidden;
    }

    .stats-panel.active { display: block; }

    .stats-header {
      padding: 20px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .stats-header h2 { margin: 0; font-size: 18px; font-weight: 600; }

    .close-stats {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--text-muted);
      padding: 4px 12px;
      border-radius: 6px;
    }

    .close-stats:hover { background: var(--content-bg); }

    /* Filters */
    .filter-section {
      padding: 16px 20px;
      background: var(--content-bg);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }

    .filter-label { font-weight: 600; font-size: 13px; color: var(--text-muted); }

    .filter-btn {
      padding: 8px 16px;
      border: 2px solid var(--dashboard-button-border, var(--button-border-color, var(--border-color)));
      background: var(--dashboard-button-bg, var(--card-bg));
      color: var(--dashboard-button-text, var(--text-color));
      border-radius: 20px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      font-family: inherit;
      transition: all 0.2s;
    }

    .filter-btn.active { background: var(--accent-color); color: var(--accent-text-color, white); border-color: var(--accent-color); }

    .filter-select {
      padding: 8px 12px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background: var(--card-bg);
      color: var(--text-color);
      font-size: 13px;
      font-family: inherit;
      cursor: pointer;
    }

    /* Stats Summary */
    .stats-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 16px;
      padding: 20px;
      background: var(--content-bg);
    }

    .summary-box { text-align: center; padding: 16px; background: var(--card-bg); border-radius: 10px; }
    .summary-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; margin-bottom: 4px; }
    .summary-value { font-size: 24px; font-weight: 700; color: var(--accent-color); }

    /* Match History Table */
    .match-history { padding: 20px; }
    .match-history h3 { margin: 0 0 16px; font-size: 16px; font-weight: 600; }

    .history-table { width: 100%; border-collapse: collapse; font-size: 14px; }

    .history-table th {
      background: var(--content-bg);
      padding: 12px;
      text-align: center;
      font-weight: 600;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
    }

    .history-table td { padding: 12px; text-align: center; border-bottom: 1px solid var(--border-color); }
    .history-table tbody tr:hover { background: var(--content-bg); }

    .opponent-cell { display: flex; align-items: center; justify-content: center; gap: 8px; }
    .opponent-logo-small { width: 24px; height: 24px; object-fit: contain; border-radius: 4px; }

    .varsity-badge {
      display: inline-block;
      padding: 4px 10px;
      background: var(--accent-color);
      color: white;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }

    .jv-badge {
      display: inline-block;
      padding: 4px 10px;
      background: var(--content-bg);
      color: var(--text-muted);
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }

    .no-stats { text-align: center; padding: 32px; color: var(--text-muted); }

    /* Message */
    .message { padding: 14px 18px; margin-bottom: 24px; border-radius: 10px; font-weight: 500; font-size: 14px; display: none; }
    .message.success { display: block; background: #dcfce7; color: #166534; }
    .message.error { display: block; background: #fef2f2; color: #991b1b; }

    /* Mobile */
    @media (max-width: 768px) {
      .navbar { padding: 12px 16px; }
      .nav-left { gap: 10px; }
      .season-select { padding: 4px 8px; }
      .season-select label { display: none; }
      .nav-links { gap: 4px; }
      .nav-links a { padding: 8px 12px; font-size: 13px; }
      .container { padding: 20px 16px; }
      .add-form { grid-template-columns: 1fr; }
      .stats-summary { grid-template-columns: repeat(2, 1fr); }
      .history-table { font-size: 12px; }
      .history-table th, .history-table td { padding: 8px 4px; }
      .tabs, .view-toggle { flex-wrap: wrap; }
    }
  </style>
</head>
<body>
  <div class="navbar">
    <div class="nav-left">
      <a href="../../index.html" class="logo">
        <img id="navLogo" src="../../assets/images/Team Logos/phLogo.png" alt="School logo">
      </a>
      <div class="season-select">
        <label for="seasonSelect">Season</label>
        <select id="seasonSelect" data-season-select>
          <option value="2025-2026">2025-26</option>
          <option value="2024-2025">2024-25</option>
          <option value="all">All Time</option>
        </select>
      </div>
    </div>
    <div class="nav-links">
      <a href="home.html">Home</a>
      <a href="players.html" class="active">Players</a>
      <a href="../settings/appearanceSettings.html">Settings</a>
      <a href="myTeam.html">My Team</a>
      <a href="#" id="logoutBtn" style="color:#fca5a5;">Logout</a>
    </div>
  </div>

  <div class="container">
    <div class="page-header">
      <h1>Players</h1>
      <p>Manage players and view individual statistics</p>
    </div>

    <div class="tabs">
      <button class="tab-btn active" data-gender="all">All</button>
      <button class="tab-btn" data-gender="boys">Boys</button>
      <button class="tab-btn" data-gender="girls">Girls</button>
    </div>

    <div class="view-toggle">
      <button class="view-btn active" data-view="cards">Card View</button>
      <button class="view-btn" data-view="sheet">Spreadsheet View</button>
    </div>

    <div id="message" class="message"></div>

    <!-- Add Player Card -->
    <div class="card" id="addPlayerCard">
      <div class="card-header">
        <div class="icon">
          <svg fill="none" viewBox="0 0 24 24" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19 7.5v3m0 0v3m0-3h3m-3 0h-3m-2.25-4.125a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zM4 19.235v-.11a6.375 6.375 0 0112.75 0v.109A12.318 12.318 0 0110.374 21c-2.331 0-4.512-.645-6.374-1.766z" />
          </svg>
        </div>
        <div>
          <h3>Add New Player</h3>
          <p>Add a player to your roster</p>
        </div>
      </div>
      <div class="card-body">
        <div class="add-form">
          <div class="form-group">
            <label>First Name *</label>
            <input type="text" id="firstName" placeholder="First name">
          </div>
          <div class="form-group">
            <label>Last Name *</label>
            <input type="text" id="lastName" placeholder="Last name">
          </div>
          <div class="form-group">
            <label>Grad Year *</label>
            <select id="gradYear">
              <option value="">Select</option>
              <option value="2025">2025</option>
              <option value="2026">2026</option>
              <option value="2027">2027</option>
              <option value="2028">2028</option>
              <option value="2029">2029</option>
            </select>
          </div>
          <button class="add-btn" id="addPlayerBtn">Add Player</button>
        </div>
      </div>
    </div>

    <!-- Players List -->
    <div class="card" id="playersListCard">
      <div class="card-header">
        <div class="icon">
          <svg fill="none" viewBox="0 0 24 24" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z" />
          </svg>
        </div>
        <div>
          <h3 id="playersTitle">All Players</h3>
          <p>Click on a player to view their statistics</p>
        </div>
      </div>
      <div id="playersList">
        <div class="no-players">Loading players...</div>
      </div>
    </div>

    <div class="card" id="spreadsheetCard" style="display: none;">
      <div class="card-header">
        <div class="icon">
          <svg fill="none" viewBox="0 0 24 24" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3 6h18M3 12h18M3 18h18" />
          </svg>
        </div>
        <div>
          <h3>Player Averages</h3>
          <p>Season averages across all matches</p>
        </div>
      </div>
      <div class="card-body">
        <div class="spreadsheet-container">
          <table class="spreadsheet-table">
            <thead>
              <tr id="spreadsheetHeaderRow">
                <th>Player</th>
                <th>Matches</th>
                <th>Avg G1</th>
                <th>Avg G2</th>
                <th>Avg G3</th>
                <th>Overall Avg</th>
              </tr>
            </thead>
            <tbody id="spreadsheetBody">
              <tr><td colspan="6" class="no-players">Loading averages...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Player Stats Panel -->
    <div class="stats-panel" id="statsPanel">
      <div class="stats-header">
        <h2 id="statsPlayerName">Player Stats</h2>
        <button class="close-stats" id="closeStats">&times;</button>
      </div>

      <div class="filter-section">
        <span class="filter-label">Filter:</span>
        <button class="filter-btn active" data-filter="all">All Matches</button>
        <button class="filter-btn" data-filter="varsity">Varsity Only</button>
        <button class="filter-btn" data-filter="jv">JV Only</button>
        <span class="filter-label" style="margin-left: 16px;">Location:</span>
        <select class="filter-select" id="locationFilter">
          <option value="all">All Locations</option>
        </select>
        <span class="filter-label">Game:</span>
        <select class="filter-select" id="gameFilter">
          <option value="all">All Games</option>
          <option value="game1">Game 1 Only</option>
          <option value="game2">Game 2 Only</option>
          <option value="game3">Game 3 Only</option>
        </select>
      </div>

      <div class="stats-summary" id="statsSummary">
        <div class="summary-box">
          <div class="summary-label">Matches</div>
          <div class="summary-value" id="totalMatches">0</div>
        </div>
        <div class="summary-box">
          <div class="summary-label">Avg G1</div>
          <div class="summary-value" id="avgGame1">0.0</div>
        </div>
        <div class="summary-box">
          <div class="summary-label">Avg G2</div>
          <div class="summary-value" id="avgGame2">0.0</div>
        </div>
        <div class="summary-box">
          <div class="summary-label">Avg G3</div>
          <div class="summary-value" id="avgGame3">0.0</div>
        </div>
        <div class="summary-box">
          <div class="summary-label">Total Avg</div>
          <div class="summary-value" id="totalAvg">0.0</div>
        </div>
      </div>

      <div class="match-history">
        <h3>Match History</h3>
        <table class="history-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Opponent</th>
              <th>G1</th>
              <th>G2</th>
              <th>G3</th>
              <th>Total</th>
              <th>Avg</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="matchHistoryBody">
            <tr><td colspan="8" class="no-stats">No match data available</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // Load saved logo
    const savedLogo = localStorage.getItem('teamLogo') || localStorage.getItem('selectedLogo');
    if (savedLogo) {
      const basePath = '../../assets/images/Team Logos/';
      const navLogo = document.getElementById('navLogo');
      if (navLogo) navLogo.src = basePath + savedLogo;
      document.querySelectorAll('[data-team-logo]').forEach(img => {
        img.src = basePath + savedLogo;
      });
    }

    let currentGender = 'all';
    let currentSeason = window.SeasonContext ? SeasonContext.getSeason() : '2025-2026';
    let currentView = 'cards';
    let coachId = null;
    let players = [];
    let selectedPlayerId = null;
    let playerRecords = [];
    let currentFilter = 'all';
    let currentLocationFilter = 'all';
    let currentGameFilter = 'all';

    function getOpponentLogo(opponentName) { return getTeamLogo(opponentName, '../../assets/images/Team Logos/'); }

    async function checkAuth() {
      const userData = localStorage.getItem('bowling_user');
      if (!userData) { window.location.href = '../auth/studentLogin.html'; return null; }
      try { const user = JSON.parse(userData); coachId = user.id; return user; }
      catch (error) { window.location.href = '../auth/studentLogin.html'; return null; }
    }

    document.querySelectorAll('.tabs .tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tabs .tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentGender = btn.dataset.gender;
        document.getElementById('playersTitle').textContent = 
          currentGender === 'all' ? 'All Players' : currentGender === 'boys' ? 'Boys Players' : 'Girls Players';
        closeStatsPanel();
        loadPlayers();
        if (currentView === 'sheet') {
          loadSpreadsheetData();
        }
      });
    });

    document.querySelectorAll('.view-toggle .view-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.view-toggle .view-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentView = btn.dataset.view;
        document.getElementById('playersListCard').style.display = currentView === 'cards' ? 'block' : 'none';
        document.getElementById('spreadsheetCard').style.display = currentView === 'sheet' ? 'block' : 'none';
        if (currentView === 'sheet') {
          loadSpreadsheetData();
        }
      });
    });

    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentFilter = btn.dataset.filter;
        displayPlayerStats();
      });
    });

    document.getElementById('locationFilter').addEventListener('change', (e) => { currentLocationFilter = e.target.value; displayPlayerStats(); });
    document.getElementById('gameFilter').addEventListener('change', (e) => { currentGameFilter = e.target.value; displayPlayerStats(); });
    document.getElementById('closeStats').addEventListener('click', closeStatsPanel);

    function closeStatsPanel() {
      document.getElementById('statsPanel').classList.remove('active');
      document.querySelectorAll('.player-card').forEach(c => c.classList.remove('selected'));
      selectedPlayerId = null;
    }

    function isMatchInSeason(matchDate, season) {
      if (season === 'all' || !matchDate) return true;
      const [startYear, endYear] = season.split('-').map(Number);
      const date = new Date(matchDate);
      const month = date.getMonth();
      const year = date.getFullYear();
      if (month >= 8) {
        return year === startYear;
      }
      return year === endYear;
    }

    function getSeasonFilteredRecords(records) {
      return records.filter(record => isMatchInSeason(record.match?.match_date, currentSeason));
    }

    function populateLocationFilter() {
      const locationSelect = document.getElementById('locationFilter');
      const locations = new Set();
      getSeasonFilteredRecords(playerRecords).forEach(r => {
        if (r.match && r.match.location) locations.add(r.match.location);
      });
      locationSelect.innerHTML = '<option value="all">All Locations</option>';
      Array.from(locations).sort().forEach(loc => {
        const option = document.createElement('option');
        option.value = loc; option.textContent = loc; locationSelect.appendChild(option);
      });
    }

    function calculateAverageStats(records) {
      let g1Sum = 0, g2Sum = 0, g3Sum = 0;
      let g1Count = 0, g2Count = 0, g3Count = 0;

      records.forEach(record => {
        if (record.game1 !== null && record.game1 !== undefined) { g1Sum += record.game1; g1Count++; }
        if (record.game2 !== null && record.game2 !== undefined) { g2Sum += record.game2; g2Count++; }
        if (record.game3 !== null && record.game3 !== undefined) { g3Sum += record.game3; g3Count++; }
      });

      const totalSum = g1Sum + g2Sum + g3Sum;
      const totalCount = g1Count + g2Count + g3Count;

      return {
        matches: records.length,
        avgG1: g1Count ? (g1Sum / g1Count).toFixed(1) : '0.0',
        avgG2: g2Count ? (g2Sum / g2Count).toFixed(1) : '0.0',
        avgG3: g3Count ? (g3Sum / g3Count).toFixed(1) : '0.0',
        overallAvg: totalCount ? (totalSum / totalCount).toFixed(1) : '0.0'
      };
    }

    async function loadSpreadsheetData() {
      const tbody = document.getElementById('spreadsheetBody');
      const headerRow = document.getElementById('spreadsheetHeaderRow');
      const showGender = currentGender === 'all';

      headerRow.innerHTML = `
        <th>Player</th>
        ${showGender ? '<th>Gender</th>' : ''}
        <th>Matches</th>
        <th>Avg G1</th>
        <th>Avg G2</th>
        <th>Avg G3</th>
        <th>Overall Avg</th>
      `;

      if (!players || players.length === 0) {
        const colSpan = showGender ? 7 : 6;
        tbody.innerHTML = `<tr><td colspan="${colSpan}" class="no-players">No players yet.</td></tr>`;
        return;
      }

      const colSpan = showGender ? 7 : 6;
      tbody.innerHTML = `<tr><td colspan="${colSpan}" class="no-players">Loading averages...</td></tr>`;

      const API_BASE = window.API_BASE_URL || 'https://strikemaster-production.up.railway.app';
      const results = await Promise.all(players.map(async (player) => {
        try {
          const res = await fetch(`${API_BASE}/api/players/${player.id}/records`);
          const records = res.ok ? await res.json() : [];
          const seasonRecords = getSeasonFilteredRecords(records);
          return { player, stats: calculateAverageStats(seasonRecords) };
        } catch (err) {
          return { player, stats: calculateAverageStats([]) };
        }
      }));

      tbody.innerHTML = results.map(({ player, stats }) => `
        <tr>
          <td>${player.first_name} ${player.last_name}</td>
          ${showGender ? `<td>${player._gender || currentGender}</td>` : ''}
          <td>${stats.matches}</td>
          <td>${stats.avgG1}</td>
          <td>${stats.avgG2}</td>
          <td>${stats.avgG3}</td>
          <td>${stats.overallAvg}</td>
        </tr>
      `).join('');
    }

    document.getElementById('logoutBtn').addEventListener('click', (e) => {
      e.preventDefault();
      if (confirm('Are you sure you want to logout?')) {
        localStorage.removeItem('supabase.auth.token');
        localStorage.removeItem('bowling_user');
        window.location.href = '../../index.html';
      }
    });

    async function loadPlayers() {
      const container = document.getElementById('playersList');
      try {
        const API_BASE = window.API_BASE_URL || 'https://strikemaster-production.up.railway.app';
        let allPlayers = [];
        if (currentGender === 'all') {
          const [boysRes, girlsRes] = await Promise.all([
            fetch(`${API_BASE}/api/players?coachId=${coachId}&gender=boys`),
            fetch(`${API_BASE}/api/players?coachId=${coachId}&gender=girls`)
          ]);
          if (boysRes.ok) { const bp = await boysRes.json(); allPlayers = [...allPlayers, ...bp.map(p => ({...p, _gender: 'boys'}))]; }
          if (girlsRes.ok) { const gp = await girlsRes.json(); allPlayers = [...allPlayers, ...gp.map(p => ({...p, _gender: 'girls'}))]; }
          players = allPlayers;
        } else {
          const response = await fetch(`${API_BASE}/api/players?coachId=${coachId}&gender=${currentGender}`);
          if (!response.ok) throw new Error('Failed to fetch players');
          players = await response.json();
        }
        if (!players || players.length === 0) {
          container.innerHTML = '<div class="no-players">No players yet. Add your first player above!</div>';
          if (currentView === 'sheet') {
            loadSpreadsheetData();
          }
          return;
        }
        container.innerHTML = players.map(player => `
          <div class="player-card" data-player-id="${player.id}" onclick="selectPlayer('${player.id}')">
            <div class="player-info">
              <h4>${player.first_name} ${player.last_name}</h4>
              <span>Class of ${player.grad_year || 'N/A'}</span>
            </div>
            <div class="player-actions">
              <button class="remove-btn" onclick="event.stopPropagation(); deletePlayer('${player.id}')">Remove</button>
            </div>
          </div>
        `).join('');
        if (currentView === 'sheet') {
          loadSpreadsheetData();
        }
      } catch (error) { console.error('Error loading players:', error); container.innerHTML = '<div class="no-players">Error loading players.</div>'; }
    }

    async function selectPlayer(playerId) {
      selectedPlayerId = playerId;
      document.querySelectorAll('.player-card').forEach(c => c.classList.remove('selected'));
      document.querySelector(`[data-player-id="${playerId}"]`).classList.add('selected');
      const player = players.find(p => p.id === playerId);
      document.getElementById('statsPlayerName').textContent = `${player.first_name} ${player.last_name}'s Stats`;
      try {
        const API_BASE = window.API_BASE_URL || 'https://strikemaster-production.up.railway.app';
        const response = await fetch(`${API_BASE}/api/players/${playerId}/records`);
        if (response.ok) playerRecords = await response.json(); else playerRecords = [];
        populateLocationFilter();
        currentLocationFilter = 'all'; currentGameFilter = 'all';
        document.getElementById('locationFilter').value = 'all';
        document.getElementById('gameFilter').value = 'all';
        displayPlayerStats();
        document.getElementById('statsPanel').classList.add('active');
        document.getElementById('statsPanel').scrollIntoView({ behavior: 'smooth' });
      } catch (error) { playerRecords = []; displayPlayerStats(); document.getElementById('statsPanel').classList.add('active'); }
    }

    function displayPlayerStats() {
      let filteredRecords = getSeasonFilteredRecords(playerRecords);
      if (currentFilter === 'varsity') filteredRecords = filteredRecords.filter(r => r.is_varsity === true);
      else if (currentFilter === 'jv') filteredRecords = filteredRecords.filter(r => r.is_varsity === false);
      if (currentLocationFilter !== 'all') filteredRecords = filteredRecords.filter(r => r.match && r.match.location === currentLocationFilter);

      const matchCount = filteredRecords.length;
      let totalG1 = 0, totalG2 = 0, totalG3 = 0, countG1 = 0, countG2 = 0, countG3 = 0, totalAll = 0, countAll = 0;

      filteredRecords.forEach(r => {
        if (currentGameFilter === 'all' || currentGameFilter === 'game1') { if (r.game1) { totalG1 += r.game1; countG1++; } }
        if (currentGameFilter === 'all' || currentGameFilter === 'game2') { if (r.game2) { totalG2 += r.game2; countG2++; } }
        if (currentGameFilter === 'all' || currentGameFilter === 'game3') { if (r.game3) { totalG3 += r.game3; countG3++; } }
        let gameTotal = 0, gamesPlayed = 0;
        if (currentGameFilter === 'all') {
          if (r.game1) { gameTotal += r.game1; gamesPlayed++; }
          if (r.game2) { gameTotal += r.game2; gamesPlayed++; }
          if (r.game3) { gameTotal += r.game3; gamesPlayed++; }
        } else if (currentGameFilter === 'game1' && r.game1) { gameTotal = r.game1; gamesPlayed = 1; }
        else if (currentGameFilter === 'game2' && r.game2) { gameTotal = r.game2; gamesPlayed = 1; }
        else if (currentGameFilter === 'game3' && r.game3) { gameTotal = r.game3; gamesPlayed = 1; }
        if (gamesPlayed > 0) { totalAll += gameTotal / gamesPlayed; countAll++; }
      });

      document.getElementById('totalMatches').textContent = matchCount;
      document.getElementById('avgGame1').textContent = countG1 > 0 ? (totalG1 / countG1).toFixed(1) : '0.0';
      document.getElementById('avgGame2').textContent = countG2 > 0 ? (totalG2 / countG2).toFixed(1) : '0.0';
      document.getElementById('avgGame3').textContent = countG3 > 0 ? (totalG3 / countG3).toFixed(1) : '0.0';
      document.getElementById('totalAvg').textContent = countAll > 0 ? (totalAll / countAll).toFixed(1) : '0.0';

      const tbody = document.getElementById('matchHistoryBody');
      if (filteredRecords.length === 0) { tbody.innerHTML = '<tr><td colspan="8" class="no-stats">No match data available for this filter</td></tr>'; return; }

      filteredRecords.sort((a, b) => {
        const dateA = a.match ? new Date(a.match.match_date) : new Date(0);
        const dateB = b.match ? new Date(b.match.match_date) : new Date(0);
        return dateB - dateA;
      });

      tbody.innerHTML = filteredRecords.map(record => {
        const match = record.match || {};
        const date = match.match_date ? new Date(match.match_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'N/A';
        const g1 = record.game1 || 0, g2 = record.game2 || 0, g3 = record.game3 || 0;
        const total = g1 + g2 + g3;
        const gamesPlayed = (record.game1 ? 1 : 0) + (record.game2 ? 1 : 0) + (record.game3 ? 1 : 0);
        const avg = gamesPlayed > 0 ? (total / gamesPlayed).toFixed(1) : '0.0';
        const opponentLogo = getOpponentLogo(match.opponent);
        const opponentDisplay = opponentLogo 
          ? `<div class="opponent-cell"><img src="${opponentLogo}" alt="${match.opponent}" class="opponent-logo-small">${match.opponent || 'Unknown'}</div>`
          : (match.opponent || 'Unknown');
        return `
          <tr>
            <td>${date}</td>
            <td>${opponentDisplay}</td>
            <td>${record.game1 || '-'}</td>
            <td>${record.game2 || '-'}</td>
            <td>${record.game3 || '-'}</td>
            <td><strong>${total}</strong></td>
            <td>${avg}</td>
            <td>${record.is_varsity ? '<span class="varsity-badge">V</span>' : '<span class="jv-badge">JV</span>'}</td>
          </tr>
        `;
      }).join('');
    }

    document.getElementById('addPlayerBtn').addEventListener('click', async () => {
      const firstName = document.getElementById('firstName').value.trim();
      const lastName = document.getElementById('lastName').value.trim();
      const gradYear = document.getElementById('gradYear').value;
      if (!firstName || !lastName || !gradYear) { showMessage('Please fill in all required fields.', 'error'); return; }
      try {
        const API_BASE = window.API_BASE_URL || 'https://strikemaster-production.up.railway.app';
        const response = await fetch(`${API_BASE}/api/players`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ coachId, firstName, lastName, gradYear: parseInt(gradYear), gender: currentGender === 'all' ? 'boys' : currentGender })
        });
        if (!response.ok) { const data = await response.json(); throw new Error(data.error || 'Failed to add player'); }
        document.getElementById('firstName').value = '';
        document.getElementById('lastName').value = '';
        document.getElementById('gradYear').value = '';
        showMessage(`${firstName} ${lastName} added successfully!`, 'success');
        loadPlayers();
      } catch (error) { showMessage(error.message || 'Failed to add player.', 'error'); }
    });

    async function deletePlayer(playerId) {
      if (!confirm('Are you sure you want to remove this player?')) return;
      try {
        const API_BASE = window.API_BASE_URL || 'https://strikemaster-production.up.railway.app';
        const response = await fetch(`${API_BASE}/api/players/${playerId}`, { method: 'DELETE' });
        if (!response.ok) { const data = await response.json(); throw new Error(data.error || 'Failed to remove player'); }
        showMessage('Player removed.', 'success');
        closeStatsPanel();
        loadPlayers();
      } catch (error) { showMessage(error.message || 'Failed to remove player.', 'error'); }
    }

    function isStudentMode() { return localStorage.getItem('bowling_role') === 'student'; }

    function applyStudentMode() {
      if (isStudentMode()) {
        const addCard = document.getElementById('addPlayerCard');
        if (addCard) addCard.style.display = 'none';
        document.querySelectorAll('.remove-btn').forEach(btn => btn.style.display = 'none');
      }
    }

    function showMessage(text, type) {
      const msg = document.getElementById('message');
      msg.textContent = text;
      msg.className = `message ${type}`;
      setTimeout(() => { msg.className = 'message'; }, 4000);
    }

    if (window.SeasonContext) {
      SeasonContext.onChange((season) => {
        currentSeason = season;
        if (selectedPlayerId) {
          populateLocationFilter();
          currentLocationFilter = 'all';
          document.getElementById('locationFilter').value = 'all';
          displayPlayerStats();
        }
        if (currentView === 'sheet') {
          loadSpreadsheetData();
        }
      });
    }

    checkAuth().then(user => { if (user) { applyStudentMode(); loadPlayers(); } });
  </script>
</body>
</html>
