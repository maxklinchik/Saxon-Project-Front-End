<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Strike Master - Boys Players</title>
  <link rel="stylesheet" type="text/css" href="../../assets/css/style.css">
  <link rel="stylesheet" type="text/css" href="../../assets/css/stored-colors.css">
  <script src="../../assets/js/accent-loader.js"></script>
  <script src="../../assets/js/config/api.js"></script>
  <script src="../../assets/js/auth-helper.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      text-align: center;
    }

    .container {
      max-width: 700px;
      margin: 40px auto;
      background: var(--card-bg);
      padding: 25px;
      border-radius: 12px;
      border: 2px solid var(--accent-color);
    }

    .split-button {
      display: flex;
      width: 300px;
      height: 40px;
      border-radius: 20px;
      overflow: hidden;
      border: 2px solid #fff;
      margin-left: 40px;
    }

    .split-button a {
      flex: 1;
      text-decoration: none;
      color: var(--main-color);
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.2s ease;
    }

    .girls { background-color: #b2b2b2; }
    .girls:hover { background-color: #929292; }
    .boys { background-color: #b2b2b2; }
    .boys:hover { background-color: #929292; }
    .split-button a.active { filter: brightness(75%); }

    button {
      background-color: var(--accent-color);
      color: white;
      border: none;
      padding: 10px 18px;
      margin: 8px;
      font-size: 14px;
      border-radius: 5px;
      cursor: pointer;
    }

    button:hover {
      background-color: var(--acccent-color-hover);
    }

    .player-form {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin: 20px 0;
      text-align: left;
    }

    .player-form label {
      display: block;
      margin-bottom: 4px;
      font-weight: 500;
    }

    .player-form input, .player-form select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-sizing: border-box;
    }

    .player-form .full-width {
      grid-column: 1 / -1;
    }

    .player-list {
      margin-top: 20px;
      text-align: left;
    }

    .player-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: white;
      padding: 12px 15px;
      border: 1px solid #ccc;
      border-radius: 6px;
      margin-bottom: 10px;
      position: relative;
      color: black;
    }

    .player-info {
      flex: 1;
    }

    .player-name {
      font-weight: bold;
      font-size: 16px;
    }

    .player-details {
      font-size: 13px;
      color: #666;
      margin-top: 4px;
    }

    .options-btn {
      cursor: pointer;
      font-size: 20px;
      padding: 4px 10px;
      border-radius: 50%;
      background: transparent;
      border: none;
      color: black;
    }

    .options-btn:hover {
      background: #ddd;
    }

    .options-menu {
      position: absolute;
      right: 15px;
      top: 45px;
      background: white;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      display: none;
      z-index: 10;
    }

    .options-menu div {
      padding: 10px 15px;
      cursor: pointer;
    }

    .options-menu div:hover {
      background: #f0f0f0;
    }

    .message {
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      display: none;
    }

    .message.success {
      background: #d4edda;
      color: #155724;
      display: block;
    }

    .message.error {
      background: #f8d7da;
      color: #721c24;
      display: block;
    }
  </style>
</head>
<body>
  <div class="navbar">
    <a href="../../index.html" class="logo">
      <img src="../../assets/images/images/phLogo.png" alt="Strike Master Logo">
    </a>

    <div class="split-button">
      <a href="boysRecords.html" class="boys active">Boys</a>
      <a href="girlsRecords.html" class="girls">Girls</a>
    </div>

    <div class="nav-links">
      <a href="teamSelector.html">Team Selector</a>
      <a href="boysRecords.html">Records</a>
      <a href="boysPlayers.html">Players</a>
      <a href="../settings/appearanceSettings.html">Settings</a>
      <a href="myTeam.html">My Team</a>
      <a href="#" id="logoutBtn" style="color:#dc3545;">Logout</a>
    </div>
  </div>

  <div class="container">
    <h1>Boys Players</h1>
    <p>Add players to your boys bowling team. They will appear in the Records tab.</p>

    <div id="message" class="message"></div>

    <div class="player-form" id="addPlayerForm">
      <div>
        <label>First Name *</label>
        <input type="text" id="firstName" required>
      </div>
      <div>
        <label>Last Name *</label>
        <input type="text" id="lastName" required>
      </div>
      <div>
        <label>Graduation Year *</label>
        <select id="gradYear" required>
          <option value="">Select Year</option>
          <option value="2025">2025</option>
          <option value="2026">2026</option>
          <option value="2027">2027</option>
          <option value="2028">2028</option>
          <option value="2029">2029</option>
        </select>
      </div>
      <div>
        <label>Email (optional)</label>
        <input type="email" id="playerEmail" placeholder="student@email.com">
      </div>
      <div class="full-width" style="text-align: center;">
        <button id="addPlayerBtn">Add Player</button>
      </div>
    </div>

    <div class="player-list" id="playerList">
      <p style="text-align:center; color:#666;">Loading players...</p>
    </div>
  </div>

<script>
  // Require authentication
  if (!auth.requireCoach('../auth/teacherLogin.html')) {
    throw new Error('Not authenticated');
  }

  const currentUser = auth.getUser();
  const GENDER = 'boys';
  let teamId = null;
  let players = [];

  // Setup logout button
  document.getElementById('logoutBtn').addEventListener('click', (e) => {
    e.preventDefault();
    if (confirm('Are you sure you want to logout?')) {
      auth.logout('../../index.html');
    }
  });

  // Get coach's team for this gender
  async function getTeam() {
    if (!currentUser || !currentUser.id) {
      document.getElementById('addPlayerForm').style.display = 'none';
      return;
    }

    try {
      const res = await api.get('/api/coach/' + currentUser.id + '/teams');
      const teams = await res.json();
      
      // Find the boys team
      const boysTeam = teams.find(t => t.gender === GENDER);
      if (boysTeam) {
        teamId = boysTeam.id;
        loadPlayers();
      } else {
        showMessage('No boys team found. Please contact support.', 'error');
      }
    } catch (err) {
      console.error('Failed to get teams:', err);
      showMessage('Failed to load team data.', 'error');
    }
  }

  // Load players from API
  async function loadPlayers() {
    if (!teamId) {
      playerList.innerHTML = '<p style="text-align:center;">Please select a team first.</p>';
      return;
    }

    try {
      const res = await api.get(`/api/teams/${teamId}/players`);
      players = await res.json();
      renderPlayers();
    } catch (err) {
      console.error("Failed to load players:", err);
      playerList.innerHTML = '<p style="text-align:center; color:red;">Failed to load players.</p>';
    }
  }

  // Render players list
  function renderPlayers() {
    if (players.length === 0) {
      playerList.innerHTML = '<p style="text-align:center; color:#666;">No players yet. Add your first player above!</p>';
      return;
    }

    playerList.innerHTML = "";
    players.forEach((player) => {
      const item = document.createElement("div");
      item.className = "player-item";

      const info = document.createElement("div");
      info.className = "player-info";

      const name = document.createElement("div");
      name.className = "player-name";
      name.textContent = player.first_name + ' ' + player.last_name;

      const details = document.createElement("div");
      details.className = "player-details";
      details.textContent = 'Class of ' + (player.grad_year || 'N/A') + (player.email ? ' • ' + player.email : '');

      info.appendChild(name);
      info.appendChild(details);

      // Three-dot menu
      const menuBtn = document.createElement("button");
      menuBtn.className = "options-btn";
      menuBtn.textContent = "⋮";

      const menu = document.createElement("div");
      menu.className = "options-menu";

      const profileOpt = document.createElement("div");
      profileOpt.textContent = "View Profile";
      profileOpt.onclick = () => {
        window.location.href = 'playerProfile.html?id=' + player.id;
      };
      menu.appendChild(profileOpt);

      const removeOpt = document.createElement("div");
      removeOpt.textContent = "Remove Player";
      removeOpt.onclick = () => removePlayer(player.id);
      menu.appendChild(removeOpt);

      menuBtn.onclick = (e) => {
        e.stopPropagation();
        document.querySelectorAll('.options-menu').forEach(m => m.style.display = 'none');
        menu.style.display = menu.style.display === "none" ? "block" : "none";
      };

      document.addEventListener("click", () => {
        menu.style.display = "none";
      });

      item.appendChild(info);
      item.appendChild(menuBtn);
      item.appendChild(menu);
      playerList.appendChild(item);
    });
  }

  // Add player
  async function addPlayer() {
    const firstName = document.getElementById('firstName').value.trim();
    const lastName = document.getElementById('lastName').value.trim();
    const gradYear = document.getElementById('gradYear').value;
    const email = document.getElementById('playerEmail').value.trim();

    if (!firstName || !lastName || !gradYear) {
      showMessage('Please fill in all required fields.', 'error');
      return;
    }

    if (!teamId) {
      showMessage('No team selected. Please log in again.', 'error');
      return;
    }

    try {
      const res = await api.post('/api/players', {
        teamId,
        firstName,
        lastName,
        gradYear,
        gender: GENDER,
        email: email || null
      });

      const data = await res.json();

      if (!res.ok) {
        showMessage(data.error || "Failed to add player", 'error');
        return;
      }

      // Clear form
      document.getElementById('firstName').value = '';
      document.getElementById('lastName').value = '';
      document.getElementById('gradYear').value = '';
      document.getElementById('playerEmail').value = '';

      showMessage(`${firstName} ${lastName} added successfully!`, 'success');
      loadPlayers();
    } catch (err) {
      console.error("Add player failed:", err);
      showMessage('Failed to add player. Please try again.', 'error');
    }
  }

  // Remove player
  async function removePlayer(playerId) {
    if (!confirm('Are you sure you want to remove this player?')) return;

    try {
      const res = await api.delete(`/api/players/${playerId}`);

      if (!res.ok) {
        const data = await res.json();
        showMessage(data.error || 'Failed to remove player', 'error');
        return;
      }

      showMessage('Player removed.', 'success');
      loadPlayers();
    } catch (err) {
      console.error("Remove player failed:", err);
      showMessage('Failed to remove player.', 'error');
    }
  }

  // Show message
  function showMessage(text, type) {
    const msg = document.getElementById('message');
    msg.textContent = text;
    msg.className = 'message ' + type;
    setTimeout(() => { msg.className = 'message'; }, 4000);
  }

  // Event listeners
  document.getElementById('addPlayerBtn').addEventListener('click', addPlayer);

  // Load on startup
  getTeam();
</script>
</body>
</html>