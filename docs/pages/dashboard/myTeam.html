<!DOCTYPE html>
<html lang="en" data-ui="cartoon">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Team - Strike Master</title>
  <link rel="icon" type="image/png" href="../../assets/images/BowlingPinCartoon.png">
  <link rel="stylesheet" type="text/css" href="../../assets/css/style.css">
  <link rel="stylesheet" type="text/css" href="../../assets/css/stored-colors.css">
  <link rel="stylesheet" type="text/css" href="../../assets/css/cartoon-ui.css">
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="../../assets/js/accent-loader.js"></script>
  <script src="../../assets/js/season-context.js"></script>
  <script src="../../assets/js/config/api.js"></script>
  <script src="../../assets/js/config/teams.js"></script>
  <script src="../../assets/js/auth-helper.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      margin: 0;
      font-family: 'Nunito', 'Segoe UI', sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 32px 24px;
    }

    .page-header {
      text-align: left;
      padding: 8px 0 24px;
    }

    .page-header h1 {
      color: var(--text-color);
      font-size: 32px;
      font-weight: 700;
      margin: 0 0 8px;
    }

    .page-header p {
      color: var(--text-muted);
      font-size: 16px;
      margin: 0;
    }

    .navbar {
      background: var(--main-color);
      padding: 12px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .navbar .logo img {
      height: 46px;
      width: 46px;
      object-fit: contain;
    }

    .nav-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .season-select {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 2px solid rgba(0, 0, 0, 0.12);
      background: rgba(255, 255, 255, 0.75);
    }

    .season-select label {
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.4px;
      text-transform: uppercase;
      color: var(--text-color);
    }

    .season-select select {
      border: none;
      background: transparent;
      font-weight: 700;
      font-size: 13px;
      color: var(--text-color);
      font-family: inherit;
    }

    .season-select select:focus {
      outline: none;
    }

    .nav-links {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .nav-links a {
      color: rgba(255,255,255,0.85);
      text-decoration: none;
      padding: 10px 16px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.2s;
    }

    .nav-links a:hover { background: rgba(255,255,255,0.1); }
    .nav-links a.active { background: var(--accent-color); color: var(--accent-text-color, white); }

    /* Trend Chart */
    .trend-section {
      padding: 20px;
      border: 1px solid var(--border-color);
      border-radius: 12px;
      background: var(--card-bg);
      margin-bottom: 20px;
    }

    .trend-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .trend-header h3 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
    }

    .trend-note {
      font-size: 12px;
      color: var(--text-muted);
    }

    .trend-section canvas {
      width: 100%;
      height: 180px;
      max-height: 28vh;
    }

    .trend-empty {
      text-align: center;
      color: var(--text-muted);
      padding: 16px 0 8px;
      font-size: 13px;
    }

    /* View Toggle */
    .view-toggle {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
    }

    .view-btn {
      padding: 12px 24px;
      border: 2px solid var(--dashboard-button-border, var(--button-border-color, var(--border-color)));
      background: var(--dashboard-button-bg, var(--card-bg));
      color: var(--dashboard-button-text, var(--text-color));
      border-radius: 8px;
      cursor: pointer;
      font-weight: 700;
      font-size: 14px;
      transition: all 0.2s ease;
      box-shadow: 0 4px 0 var(--button-shadow-color, rgba(0, 0, 0, 0.15));
    }

    .view-btn:hover {
      border-color: var(--accent-color);
    }

    .view-btn.active {
      background: var(--accent-color);
      color: var(--accent-text-color, white);
      border-color: var(--accent-color);
    }

    /* Filters */
    .filters {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: flex-end;
    }

    .filter-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .filter-group label {
      font-weight: 600;
    }

    .filter-group select {
      padding: 8px 12px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background: var(--card-bg);
      color: var(--text-color);
      font-size: 14px;
    }

    .export-btn {
      background: var(--accent-color);
      color: var(--accent-text-color, white);
      border: 2px solid var(--button-border-color, rgba(0, 0, 0, 0.18));
      padding: 10px 20px;
      border-radius: 999px;
      cursor: pointer;
      font-weight: 700;
      font-size: 14px;
      transition: all 0.2s ease;
      box-shadow: 0 4px 0 var(--button-shadow-color, rgba(0, 0, 0, 0.15));
    }

    .export-btn:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
    }

    /* Add extra margin below the tabs in players-view */
    .players-view .tabs {
      margin-top: 18px;
      margin-bottom: 32px;
    }

    .tab-btn {
      padding: 12px 24px;
      border: 2px solid var(--dashboard-button-border, var(--button-border-color, var(--border-color)));
      background: var(--dashboard-button-bg, var(--card-bg));
      color: var(--dashboard-button-text, var(--text-color));
      border-radius: 8px;
      cursor: pointer;
      font-weight: 700;
      font-size: 14px;
      transition: all 0.2s ease;
      box-shadow: 0 4px 0 var(--button-shadow-color, rgba(0, 0, 0, 0.15));
    }

    .tab-btn:hover {
      border-color: var(--accent-color);
    }

    .tab-btn.active {
      background: var(--accent-color);
      color: var(--accent-text-color, white);
      border-color: var(--accent-color);
    }

    /* Stats Summary Cards */
    .stats-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 25px;
    }

    .stat-card {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 15px;
      text-align: center;
    }

    .stat-card .stat-value {
      font-size: 28px;
      font-weight: 700;
      color: var(--accent-color);
    }

    .stat-card .stat-label {
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
    }

    /* Spreadsheet Table */
    .spreadsheet-container {
      background: var(--card-bg);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .spreadsheet-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    .spreadsheet-table th {
      background: var(--accent-color);
      color: white;
      padding: 12px 10px;
      text-align: left;
      font-weight: 600;
      position: sticky;
      top: 0;
      white-space: nowrap;
    }

    .spreadsheet-table th.sortable {
      cursor: pointer;
    }

    .spreadsheet-table th.sortable:hover {
      background: color-mix(in srgb, var(--accent-color) 80%, black);
    }

    .spreadsheet-table td {
      padding: 10px;
      border-bottom: 1px solid rgba(0,0,0,0.1);
    }

    .spreadsheet-table tbody tr:hover {
      background: rgba(0,0,0,0.03);
    }

    .spreadsheet-table .opponent-cell {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .opponent-logo {
      width: 24px;
      height: 24px;
      object-fit: contain;
    }

    .result-win {
      color: #28a745;
      font-weight: 600;
    }

    .result-loss {
      color: #dc3545;
      font-weight: 600;
    }

    .result-tie {
      color: #ffc107;
      font-weight: 600;
    }

    .no-data {
      text-align: center;
      padding: 40px;
      color: #888;
    }

    /* Players View Styles */
    .team-section {
      max-width: 900px;
      margin: 0 auto;
      padding: 0 20px;
    }

    .team-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .team-header h2 {
      color: var(--accent-color);
      margin: 0;
    }

    .add-player-btn {
      background: var(--accent-color);
      color: var(--accent-text-color, white);
      border: 2px solid var(--button-border-color, rgba(0, 0, 0, 0.18));
      box-shadow: 0 4px 0 var(--button-shadow-color, rgba(0, 0, 0, 0.15));
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }

    .player-form {
      background: var(--card-bg);
      border: 2px solid var(--accent-color);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      display: none;
    }

    .player-form.active {
      display: block;
    }

    .player-form h3 {
      margin-top: 0;
      color: var(--accent-color);
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .form-grid label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }

    .form-grid input, .form-grid select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-sizing: border-box;
    }

    .form-actions {
      margin-top: 15px;
      text-align: right;
    }

    .form-actions button {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 600;
      margin-left: 10px;
    }

    .btn-save {
      background: var(--accent-color);
      color: var(--accent-text-color, white);
      border: 2px solid var(--button-border-color, rgba(0, 0, 0, 0.18));
      box-shadow: 0 4px 0 var(--button-shadow-color, rgba(0, 0, 0, 0.15));
    }

    .btn-cancel {
      background: #ccc;
      color: #333;
      border: 2px solid var(--button-border-color, rgba(0, 0, 0, 0.25));
      box-shadow: 0 4px 0 var(--button-shadow-color, rgba(0, 0, 0, 0.15));
    }

    .players-list {
      background: var(--card-bg);
      border: 2px solid var(--accent-color);
      border-radius: 12px;
      overflow: hidden;
    }

    .player-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      border-bottom: 1px solid #eee;
    }

    .player-item:last-child {
      border-bottom: none;
    }

    .player-info h4 {
      margin: 0 0 5px 0;
      color: var(--text-color);
    }

    .player-info span {
      font-size: 14px;
      color: #666;
    }

    .player-actions button {
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 18px;
      padding: 5px 10px;
    }

    .no-players {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .message {
      padding: 12px;
      margin-bottom: 15px;
      border-radius: 8px;
      display: none;
    }

    .message.success {
      background: #d4edda;
      color: #155724;
      display: block;
    }

    .message.error {
      background: #f8d7da;
      color: #721c24;
      display: block;
    }

    .invite-section {
      background: var(--card-bg);
      border: 2px solid var(--accent-color);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .invite-section h3 {
      color: var(--accent-color);
      margin-top: 0;
      margin-bottom: 12px;
    }

    .invite-row {
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: 12px;
      align-items: center;
    }

    .invite-row input {
      padding: 10px 12px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background: var(--content-bg);
      color: var(--text-color);
    }

    .invite-toggle {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
    }

    .invite-toggle input {
      width: 18px;
      height: 18px;
      accent-color: var(--accent-color);
    }

    .invite-btn {
      background: var(--accent-color);
      color: var(--accent-text-color, white);
      border: 2px solid var(--button-border-color, rgba(0, 0, 0, 0.18));
      padding: 10px 18px;
      border-radius: 999px;
      cursor: pointer;
      font-weight: 700;
    }

    .invite-list {
      margin-top: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .invite-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      border-radius: 8px;
      background: var(--content-bg);
    }

    .footer {
      text-align: center;
      padding: 20px;
      margin-top: 30px;
      color: var(--text-color);
      opacity: 0.6;
    }


    /* Hide sections */
    .stats-view, .players-view {
      display: none;
    }

    .stats-view.active, .players-view.active {
      display: block;
    }

    @media (max-width: 768px) {
      .navbar { padding: 12px 16px; }
      .nav-left { gap: 10px; }
      .season-select { padding: 4px 8px; }
      .season-select label { display: none; }
      .nav-links { gap: 4px; }
      .nav-links a { padding: 8px 12px; font-size: 13px; }
      .container { padding: 20px 16px; }
      .view-toggle, .tabs { flex-wrap: wrap; justify-content: center; }
    }
  </style>
</head>
<body class="dashboard">
  <div class="navbar">
    <div class="nav-left">
      <a href="../../index.html" class="logo">
        <img id="navLogo" src="../../assets/images/Team Logos/phLogo.png" alt="School logo">
      </a>
      <div class="season-select">
        <label for="seasonSelect">Season</label>
        <select id="seasonSelect" data-season-select>
          <option value="2025-2026">2025-26</option>
          <option value="2024-2025">2024-25</option>
          <option value="all">All Time</option>
        </select>
      </div>
    </div>
    <div class="nav-links">
      <a href="home.html">Home</a>
      <a href="players.html">Players</a>
      <a href="../settings/appearanceSettings.html">Settings</a>
      <a href="myTeam.html" class="active">My Team</a>
      <a href="announcements.html">Announcements</a>
      <a href="#" id="logoutBtn" style="color:#dc3545;">Logout</a>
    </div>
  </div>

  <div class="container">
    <div class="page-header">
      <h1>My Team</h1>
      <p id="welcomeMsg">View your team's season statistics and match history.</p>
    </div>

    <!-- View Toggle -->
    <div class="view-toggle">
      <button class="view-btn active" data-view="stats">Match Stats</button>
      <button class="view-btn" data-view="players">Manage Players</button>
    </div>

    <!-- Match Stats View -->
    <div class="stats-view active" id="statsView">
      <div class="invite-section">
        <h3>Invite Coaches</h3>
        <div class="invite-row">
          <input type="text" id="inviteCoachIdentifier" placeholder="Coach email or coach code">
          <label class="invite-toggle">
            <input type="checkbox" id="inviteCoachCanEdit">
            <span>Can edit</span>
          </label>
          <button class="invite-btn" id="inviteCoachBtn" type="button">Invite</button>
        </div>
        <div class="invite-list" id="inviteCoachList"></div>
      </div>

      <div class="filters">
        <button class="export-btn" onclick="exportToCSV()">
          Export CSV
        </button>
      </div>

      <div class="tabs" id="statsTabs">
        <button class="tab-btn active" data-gender="all">All</button>
        <button class="tab-btn" data-gender="boys">Boys</button>
        <button class="tab-btn" data-gender="girls">Girls</button>
      </div>

      <!-- Season Stats Summary -->
      <div class="stats-cards" id="statsCards">
        <div class="stat-card">
          <div class="stat-value" id="totalMatches">0</div>
          <div class="stat-label">Matches</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="winRecord">0-0</div>
          <div class="stat-label">Record (W-L)</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="teamAverage">0</div>
          <div class="stat-label">Team Avg</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="highMatch">0</div>
          <div class="stat-label">High Match</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="lowMatch">0</div>
          <div class="stat-label">Low Match</div>
        </div>
      </div>

      <div class="trend-section">
        <div class="trend-header">
          <h3>Team Trend</h3>
          <span class="trend-note">Match total vs average per player</span>
        </div>
        <canvas id="teamTrendChart" height="160"></canvas>
        <div class="trend-empty" id="trendEmpty" style="display: none;">No match data available for trend.</div>
      </div>

      <!-- Matches Spreadsheet -->
      <div class="spreadsheet-container">
        <table class="spreadsheet-table">
          <thead>
            <tr>
              <th class="sortable" data-sort="date">Date ▼</th>
              <th>Opponent</th>
              <th>Location</th>
              <th class="sortable" data-sort="total">Match Total</th>
              <th class="sortable" data-sort="avg">Match Avg</th>
              <th>Score</th>
            </tr>
          </thead>
          <tbody id="matchesBody">
            <tr><td colspan="6" class="no-data">Loading matches...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Players View -->
    <div class="players-view" id="playersView">
      <div class="team-section">
        <div id="message" class="message"></div>

        <div class="tabs" id="playersTabs">
          <button class="tab-btn active" data-gender="boys">Boys Team</button>
          <button class="tab-btn" data-gender="girls">Girls Team</button>
        </div>

        <div class="team-header">
          <h2 id="teamTitle">Boys Team</h2>
          <button class="add-player-btn" id="addPlayerBtn">+ Add Player</button>
        </div>

        <div class="player-form" id="playerForm">
          <h3>Add New Player</h3>
          <div class="form-grid">
            <div>
              <label>First Name *</label>
              <input type="text" id="firstName" required>
            </div>
            <div>
              <label>Last Name *</label>
              <input type="text" id="lastName" required>
            </div>
            <div>
              <label>Graduation Year *</label>
              <select id="gradYear" required>
                <option value="">Select Year</option>
                <option value="2025">2025</option>
                <option value="2026">2026</option>
                <option value="2027">2027</option>
                <option value="2028">2028</option>
                <option value="2029">2029</option>
              </select>
            </div>
            <div>
              <label>Email (optional)</label>
              <input type="email" id="playerEmail" placeholder="student@email.com">
            </div>
          </div>
          <div class="form-actions">
            <button class="btn-cancel" id="cancelBtn">Cancel</button>
            <button class="btn-save" id="savePlayerBtn">Add Player</button>
          </div>
        </div>

        <div class="players-list" id="playersList">
          <div class="no-players">Loading players...</div>
        </div>
      </div>
    </div>
  </div>

  <div class="footer">
    <p>&copy; 2025 Strike Master | My Team</p>
  </div>

  <script>
    // Load saved logo
    const savedLogo = localStorage.getItem('teamLogo') || localStorage.getItem('selectedLogo');
    if (savedLogo) {
      const basePath = '../../assets/images/Team Logos/';
      const navLogo = document.getElementById('navLogo');
      if (navLogo) navLogo.src = basePath + savedLogo;
      document.querySelectorAll('[data-team-logo]').forEach(img => {
        img.src = basePath + savedLogo;
      });
    }

    // Require authentication
    if (!auth.requireAuth('../auth/login.html')) {
      throw new Error('Not authenticated');
    }

    const currentUser = auth.getUser();
    let coachId = currentUser?.id;
    let currentStatsGender = 'all';
    let currentPlayerGender = 'boys';
    let currentSeason = window.SeasonContext ? SeasonContext.getSeason() : '2025-2026';
    let allMatches = [];
    let players = [];
    let sortColumn = 'date';
    let sortDirection = 'desc';
    let teamTrendChart = null;
    let activeOwnerCoachId = currentUser?.id;
    let canEditTeamAccess = true;

    // Export to CSV function
    function exportToCSV() {
      const matches = getFilteredMatches();
      if (matches.length === 0) {
        alert('No matches to export.');
        return;
      }
      
      const headers = ['Date', 'Opponent', 'Gender', 'Location', 'Match Total', 'Match Avg', 'Score'];
      const rows = matches.map(match => {
        const dateValue = parseLocalDate(match.match_date);
        const date = dateValue ? dateValue.toLocaleDateString('en-US', { 
          month: 'short', day: 'numeric', year: 'numeric' 
        }) : 'N/A';
        const total = getMatchTotal(match);
        const avg = getMatchAvg(match).toFixed(1);
        const score = `${match.your_points || 0}-${match.opponent_points || 0}`;
        return [date, match.opponent, match.gender || '', match.location || '', total, avg, score];
      });
      
      const csvContent = [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `team_matches_${currentSeason}.csv`;
      link.click();
      URL.revokeObjectURL(link.href);
    }

    // Update welcome message
    document.getElementById('welcomeMsg').textContent = 
      `${auth.getDisplayName()}'s team statistics and match history.`;

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', (e) => {
      e.preventDefault();
      if (confirm('Are you sure you want to logout?')) {
        auth.logout('../../index.html');
      }
    });

    // View Toggle
    document.querySelectorAll('.view-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const view = btn.dataset.view;
        document.getElementById('statsView').classList.toggle('active', view === 'stats');
        document.getElementById('playersView').classList.toggle('active', view === 'players');
        if (view === 'players') loadPlayers();
      });
    });

    // Stats Tab switching
    document.querySelectorAll('#statsTabs .tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('#statsTabs .tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentStatsGender = btn.dataset.gender;
        renderData();
      });
    });

    if (window.SeasonContext) {
      SeasonContext.onChange((season) => {
        currentSeason = season;
        renderData();
      });
    }

    // Sortable columns
    document.querySelectorAll('.sortable').forEach(th => {
      th.addEventListener('click', () => {
        const col = th.dataset.sort;
        if (sortColumn === col) {
          sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
          sortColumn = col;
          sortDirection = 'desc';
        }
        renderData();
      });
    });

    // Load matches from API
    async function loadMatches() {
      try {
        const API_BASE = window.API_BASE_URL || 'https://strikemaster-production.up.railway.app';
        const response = await fetch(`${API_BASE}/api/matches?coachId=${coachId}`);
        
        if (!response.ok) throw new Error('Failed to load matches');
        
        allMatches = await response.json();
        
        // Load records for each match
        for (const match of allMatches) {
          try {
            const recordsRes = await fetch(`${API_BASE}/api/records?matchId=${match.id}`);
            if (recordsRes.ok) {
              match.records = await recordsRes.json();
            } else {
              match.records = [];
            }
          } catch (err) {
            match.records = [];
          }
        }
        
        renderData();
      } catch (error) {
        console.error('Error loading matches:', error);
        document.getElementById('matchesBody').innerHTML = 
          '<tr><td colspan="8" class="no-data">Error loading matches</td></tr>';
      }
    }

    // Filter matches by season and gender
    function getFilteredMatches() {
      let filtered = allMatches;
      
      // Filter by gender
      if (currentStatsGender !== 'all') {
        filtered = filtered.filter(m => m.gender === currentStatsGender);
      }
      
      // Filter by season
      if (currentSeason !== 'all') {
        const [startYear, endYear] = currentSeason.split('-').map(Number);
        filtered = filtered.filter(m => {
          const matchDate = new Date(m.match_date);
          const month = matchDate.getMonth();
          const year = matchDate.getFullYear();
          // Season runs from September to June
          if (month >= 8) { // Sept-Dec
            return year === startYear;
          } else { // Jan-June
            return year === endYear;
          }
        });
      }
      
      // Sort
      filtered.sort((a, b) => {
        let valA, valB;
        switch (sortColumn) {
          case 'date':
            valA = new Date(a.match_date);
            valB = new Date(b.match_date);
            break;
          case 'total':
            valA = getMatchTotal(a);
            valB = getMatchTotal(b);
            break;
          case 'avg':
            valA = getMatchAvg(a);
            valB = getMatchAvg(b);
            break;
          default:
            valA = new Date(a.match_date);
            valB = new Date(b.match_date);
        }
        if (sortDirection === 'asc') {
          return valA > valB ? 1 : -1;
        } else {
          return valA < valB ? 1 : -1;
        }
      });
      
      return filtered;
    }

    // Get match total wood (varsity only)
    function getMatchTotal(match) {
      if (!match.records || match.records.length === 0) return match.total_wood || 0;
      const varsity = match.records.filter(r => r.is_varsity);
      if (varsity.length === 0) return match.total_wood || 0;
      return varsity.reduce((sum, r) => sum + (r.total || 0), 0);
    }

    // Get match average
    function getMatchAvg(match) {
      if (!match.records || match.records.length === 0) return 0;
      const varsity = match.records.filter(r => r.is_varsity);
      if (varsity.length === 0) return 0;
      const total = varsity.reduce((sum, r) => sum + (r.total || 0), 0);
      return total / varsity.length;
    }

    function parseLocalDate(value) {
      if (!value) return null;
      if (value instanceof Date) return value;
      if (typeof value === 'string') {
        const match = value.match(/^(\d{4})-(\d{2})-(\d{2})/);
        if (match) {
          const year = Number(match[1]);
          const month = Number(match[2]) - 1;
          const day = Number(match[3]);
          return new Date(year, month, day);
        }
      }
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) return null;
      return new Date(date.getFullYear(), date.getMonth(), date.getDate());
    }

    function buildTeamTrendData(matches) {
      const trendMatches = matches
        .filter(m => m.match_date)
        .sort((a, b) => {
          const dateA = parseLocalDate(a.match_date);
          const dateB = parseLocalDate(b.match_date);
          return (dateA ? dateA.getTime() : 0) - (dateB ? dateB.getTime() : 0);
        });

      const labels = [];
      const totalSeries = [];
      const avgSeries = [];

      trendMatches.forEach(match => {
        const dateValue = parseLocalDate(match.match_date);
        if (!dateValue) return;
        const total = getMatchTotal(match);
        const avg = getMatchAvg(match);
        labels.push(dateValue.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
        totalSeries.push(total);
        avgSeries.push(Number(avg.toFixed(1)));
      });

      return { labels, totalSeries, avgSeries };
    }

    function updateTeamTrendChart(matches) {
      const { labels, totalSeries, avgSeries } = buildTeamTrendData(matches);
      const emptyState = document.getElementById('trendEmpty');
      const canvas = document.getElementById('teamTrendChart');

      if (!labels.length) {
        emptyState.style.display = 'block';
        canvas.style.display = 'none';
        if (teamTrendChart) { teamTrendChart.destroy(); teamTrendChart = null; }
        return;
      }

      emptyState.style.display = 'none';
      canvas.style.display = 'block';

      const data = {
        labels,
        datasets: [
          {
            label: 'Match Total',
            data: totalSeries,
            borderColor: '#4f46e5',
            backgroundColor: 'rgba(79, 70, 229, 0.15)',
            tension: 0.25,
            fill: true,
            pointRadius: 3
          },
          {
            label: 'Avg per Player',
            data: avgSeries,
            borderColor: '#f97316',
            backgroundColor: 'rgba(249, 115, 22, 0.15)',
            tension: 0.25,
            fill: true,
            pointRadius: 3
          }
        ]
      };

      const textColor = getComputedStyle(document.body).getPropertyValue('--text-color') || '#1f1f1f';
      const options = {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            ticks: { color: textColor },
            grid: { color: 'rgba(0,0,0,0.08)' }
          },
          x: {
            ticks: { color: textColor },
            grid: { display: false }
          }
        },
        plugins: {
          legend: { labels: { color: textColor } },
          tooltip: { mode: 'index', intersect: false }
        }
      };

      if (teamTrendChart) {
        teamTrendChart.data = data;
        teamTrendChart.options = options;
        teamTrendChart.update();
      } else {
        teamTrendChart = new Chart(canvas.getContext('2d'), { type: 'line', data, options });
      }
    }

    // Render data
    function renderData() {
      const matches = getFilteredMatches();
      
      // Calculate season stats
      let totalMatches = matches.length;
      let wins = 0, losses = 0;
      let allMatchTotals = [];
      let totalAvgSum = 0;
      
      matches.forEach(m => {
        if (m.result === 'win') wins++;
        else if (m.result === 'loss') losses++;
        
        const matchTotal = getMatchTotal(m);
        if (matchTotal > 0) {
          allMatchTotals.push(matchTotal);
          totalAvgSum += getMatchAvg(m);
        }
        
      });
      
      // Update stats cards
      document.getElementById('totalMatches').textContent = totalMatches;
      document.getElementById('winRecord').textContent = `${wins}-${losses}`;
      document.getElementById('teamAverage').textContent = totalMatches > 0 
        ? (totalAvgSum / totalMatches).toFixed(1) : '0';
      document.getElementById('highMatch').textContent = allMatchTotals.length > 0 
        ? Math.max(...allMatchTotals) : '0';
      document.getElementById('lowMatch').textContent = allMatchTotals.length > 0 
        ? Math.min(...allMatchTotals) : '0';
      
      // Find highest and lowest match totals for highlighting
      updateTeamTrendChart(matches);
      
      // Render table
      const tbody = document.getElementById('matchesBody');
      
      if (matches.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="no-data">No matches found for this filter.</td></tr>';
        return;
      }
      
      tbody.innerHTML = matches.map(match => {
        const dateValue = parseLocalDate(match.match_date);
        const formattedDate = dateValue ? dateValue.toLocaleDateString('en-US', { 
          month: 'short', day: 'numeric', year: 'numeric' 
        }) : 'N/A';
        
        const total = getMatchTotal(match);
        const avg = getMatchAvg(match).toFixed(1);
        const matchTotal = total;
        const matchAvg = avg;
        
        const opponentLogo = getTeamLogo(match.opponent) || '';
        
        // Calculate and show final score out of 7 (2/game, 1 for total)
        let resultClass = '';
        // Use stored game scores if available, else fallback to points/result
        let teamG1 = match.team_g1 || 0;
        let teamG2 = match.team_g2 || 0;
        let teamG3 = match.team_g3 || 0;
        let oppG1 = match.opp_g1 || 0;
        let oppG2 = match.opp_g2 || 0;
        let oppG3 = match.opp_g3 || 0;
        let teamTotal = teamG1 + teamG2 + teamG3;
        let oppTotal = oppG1 + oppG2 + oppG3;
        let ourPoints = 0, oppPoints = 0;
        if (teamG1 > oppG1) ourPoints += 2; else if (oppG1 > teamG1) oppPoints += 2;
        if (teamG2 > oppG2) ourPoints += 2; else if (oppG2 > teamG2) oppPoints += 2;
        if (teamG3 > oppG3) ourPoints += 2; else if (oppG3 > teamG3) oppPoints += 2;
        if (teamTotal > oppTotal) ourPoints += 1; else if (oppTotal > teamTotal) oppPoints += 1;
        // If no game scores, fallback to stored points/result
        let hasGameScores = teamG1 || teamG2 || teamG3 || oppG1 || oppG2 || oppG3;
        if (!hasGameScores) {
          ourPoints = match.your_points || 0;
          oppPoints = match.opponent_points || 0;
          if ((ourPoints === 0 && oppPoints === 0) && match.result) {
            if (match.result === 'win') { ourPoints = 7; oppPoints = 0; }
            else if (match.result === 'loss') { ourPoints = 0; oppPoints = 7; }
            else if (match.result === 'tie') { ourPoints = 3.5; oppPoints = 3.5; }
          }
        }
        if (ourPoints > oppPoints) resultClass = 'result-win';
        else if (oppPoints > ourPoints) resultClass = 'result-loss';
        else if (ourPoints === oppPoints && (ourPoints !== 0 || oppPoints !== 0)) resultClass = 'result-tie';
        let resultText = `${ourPoints} - ${oppPoints}`;
        
        return `
          <tr>
            <td>${formattedDate}</td>
            <td>
              <div class="opponent-cell">
                ${opponentLogo ? `<img src="${opponentLogo}" class="opponent-logo" alt="">` : ''}
                ${match.opponent}
                ${match.gender === 'boys' ? ' (B)' : match.gender === 'girls' ? ' (G)' : ''}
              </div>
            </td>
            <td>${match.location || '-'}</td>
            <td><strong>${matchTotal || '-'}</strong></td>
            <td>${matchAvg}</td>
            <td class="${resultClass}">${resultText}</td>
          </tr>
        `;
      }).join('');
    }

    // ====== PLAYERS MANAGEMENT ======

    // Players Tab switching
    document.querySelectorAll('#playersTabs .tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('#playersTabs .tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentPlayerGender = btn.dataset.gender;
        document.getElementById('teamTitle').textContent = currentPlayerGender === 'boys' ? 'Boys Team' : 'Girls Team';
        loadPlayers();
      });
    });

    // Load players from API
    async function loadPlayers() {
      if (!currentUser || !currentUser.id) {
        showMessage('User session invalid. Please log in again.', 'error');
        document.getElementById('playersList').innerHTML = '<div class="no-players">Please log in to manage your team.</div>';
        return;
      }

      try {
        const res = await api.get(`/api/players?coachId=${currentUser.id}&gender=${currentPlayerGender}`);
        
        if (!res.ok) {
          const err = await res.json();
          showMessage(err.error || 'Failed to load players.', 'error');
          document.getElementById('playersList').innerHTML = '<div class="no-players">Failed to load players.</div>';
          return;
        }
        
        players = await res.json();
        renderPlayers();
      } catch (err) {
        console.error('Failed to load players:', err);
        document.getElementById('playersList').innerHTML = '<div class="no-players">Failed to load players.</div>';
      }
    }

    let editingPlayerId = null;

    function startEditPlayer(playerId) {
      const player = players.find(p => p.id === playerId);
      if (!player) return;
      editingPlayerId = playerId;
      document.getElementById('firstName').value = player.first_name || '';
      document.getElementById('lastName').value = player.last_name || '';
      document.getElementById('gradYear').value = player.grad_year || '';
      document.getElementById('playerEmail').value = player.email || '';
      document.querySelector('#playerForm h3').textContent = 'Edit Player';
      document.getElementById('savePlayerBtn').textContent = 'Save Changes';
      document.getElementById('playerForm').classList.add('active');
    }

    function resetPlayerForm() {
      editingPlayerId = null;
      document.querySelector('#playerForm h3').textContent = 'Add New Player';
      document.getElementById('savePlayerBtn').textContent = 'Add Player';
      document.getElementById('firstName').value = '';
      document.getElementById('lastName').value = '';
      document.getElementById('gradYear').value = '';
      document.getElementById('playerEmail').value = '';
    }

    // Render players
    function renderPlayers() {
      const list = document.getElementById('playersList');
      
      if (players.length === 0) {
        list.innerHTML = '<div class="no-players">No players yet. Click "+ Add Player" to get started!</div>';
        return;
      }

      list.innerHTML = players.map(player => 
        '<div class="player-item">' +
          '<div class="player-info">' +
            '<h4>' + player.first_name + ' ' + player.last_name + '</h4>' +
            '<span>Class of ' + (player.grad_year || 'N/A') + (player.email ? ' • ' + player.email : '') + '</span>' +
          '</div>' +
          '<div class="player-actions">' +
            '<button onclick="startEditPlayer(\'' + player.id + '\')" title="Edit">Edit</button>' +
            '<button onclick="removePlayer(\'' + player.id + '\')" title="Remove">Remove</button>' +
          '</div>' +
        '</div>'
      ).join('');
    }

    // Add player
    async function addPlayer() {
      const firstName = document.getElementById('firstName').value.trim();
      const lastName = document.getElementById('lastName').value.trim();
      const gradYear = document.getElementById('gradYear').value;
      const email = document.getElementById('playerEmail').value.trim();

      if (!firstName || !lastName || !gradYear) {
        showMessage('Please fill in all required fields.', 'error');
        return;
      }

      if (!currentUser || !currentUser.id) {
        showMessage('Not logged in. Please log in again.', 'error');
        return;
      }

      try {
        let res;
        if (editingPlayerId) {
          res = await api.put(`/api/players/${editingPlayerId}`, {
            coachId: currentUser.id,
            firstName,
            lastName,
            gradYear,
            gender: currentPlayerGender,
            email
          });
        } else {
          res = await api.post('/api/players', {
            coachId: currentUser.id,
            firstName,
            lastName,
            gradYear,
            gender: currentPlayerGender,
            email,
            ownerCoachId: activeOwnerCoachId
          });
        }

        if (!res.ok) {
          const data = await res.json();
          showMessage(data.error || 'Failed to save player', 'error');
          return;
        }

        const data = await res.json();

        document.getElementById('playerForm').classList.remove('active');
        if (!editingPlayerId && data.emailStatus && !data.emailStatus.sent && email) {
          showMessage(`${firstName} ${lastName} added, but email not sent: ${data.emailStatus.error || 'unknown error'}`, 'error');
        } else {
          showMessage(editingPlayerId ? 'Player updated.' : `${firstName} ${lastName} added successfully!`, 'success');
        }
        resetPlayerForm();
        loadPlayers();
      } catch (err) {
        console.error('Add player failed:', err);
        showMessage('Failed to save player.', 'error');
      }
    }

    async function loadCoachInvites() {
      try {
        const res = await api.get(`/api/coach-access?ownerCoachId=${currentUser.id}`);
        if (!res.ok) return;
        const data = await res.json();
        const list = document.getElementById('inviteCoachList');
        list.innerHTML = (data || []).map(entry => {
          const label = entry.email || entry.team_code || entry.name || entry.coach_id;
          return `
            <div class="invite-item">
              <div>${label} • ${entry.can_edit ? 'Can edit' : 'View only'}</div>
              <button class="remove-btn" data-coach-id="${entry.coach_id}">Remove</button>
            </div>
          `;
        }).join('');

        list.querySelectorAll('.remove-btn').forEach(btn => {
          btn.addEventListener('click', async () => {
            const coachId = btn.dataset.coachId;
            const removeRes = await api.delete(`/api/coach-access/${coachId}?ownerCoachId=${currentUser.id}`);
            if (removeRes.ok) loadCoachInvites();
          });
        });
      } catch (error) {
        console.error('Load coach invites failed:', error);
      }
    }

    async function loadOwnerTeams() {
      try {
        const res = await api.get(`/api/coach-access/owners?coachId=${currentUser.id}`);
        if (!res.ok) return;
        const data = await res.json();
        if (!data.length) {
          activeOwnerCoachId = currentUser.id;
          canEditTeamAccess = true;
          document.querySelector('.invite-section').style.display = 'block';
          return;
        }
        activeOwnerCoachId = data[0].owner_coach_id;
        canEditTeamAccess = !!data[0].can_edit;
        document.querySelector('.invite-section').style.display = 'none';
      } catch (error) {
        console.error('Load owner teams failed:', error);
      }
    }

    document.getElementById('inviteCoachBtn')?.addEventListener('click', async () => {
      const identifier = document.getElementById('inviteCoachIdentifier').value.trim();
      const canEdit = document.getElementById('inviteCoachCanEdit').checked;
      if (!identifier) {
        showMessage('Enter a coach email or code.', 'error');
        return;
      }
      const res = await api.post('/api/coach-access', {
        ownerCoachId: currentUser.id,
        identifier,
        canEdit
      });
      if (!res.ok) {
        const data = await res.json();
        showMessage(data.error || 'Failed to invite coach.', 'error');
        return;
      }
      document.getElementById('inviteCoachIdentifier').value = '';
      document.getElementById('inviteCoachCanEdit').checked = false;
      loadCoachInvites();
    });

    // Remove player
    async function removePlayer(playerId) {
      if (!confirm('Are you sure you want to remove this player?')) return;

      try {
        const res = await api.delete(`/api/players/${playerId}`);
        if (res.ok) {
          showMessage('Player removed.', 'success');
          loadPlayers();
        } else {
          showMessage('Failed to remove player.', 'error');
        }
      } catch (err) {
        console.error('Remove player failed:', err);
        showMessage('Failed to remove player.', 'error');
      }
    }

    // Show message
    function showMessage(text, type) {
      const msg = document.getElementById('message');
      msg.textContent = text;
      msg.className = `message ${type}`;
      setTimeout(() => { msg.className = 'message'; }, 4000);
    }

    // Toggle form
    document.getElementById('addPlayerBtn').addEventListener('click', () => {
      resetPlayerForm();
      document.getElementById('playerForm').classList.toggle('active');
    });

    document.getElementById('cancelBtn').addEventListener('click', () => {
      document.getElementById('playerForm').classList.remove('active');
      resetPlayerForm();
    });

    document.getElementById('savePlayerBtn').addEventListener('click', addPlayer);

    // Initialize - load matches
    loadOwnerTeams().then(() => {
      loadMatches();
      if (canEditTeamAccess) {
        loadCoachInvites();
      }
    });
  </script>
</body>
</html>
